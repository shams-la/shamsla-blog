var $window=$(window),g$cmt_section=$("div#comments"),g$cmt_page_number=1,g$cmt_area=$("textarea.main-area"),g$cmt_req_pending=!1;async function targetAction(e){const t={pid:g$post_id},n=$(e.currentTarget),i=n.children().first().attr("class");removeAdd(n,"spin");const a=await postRequest("/post/like/",t);if(removeAdd(n,`<i class="${i}"></i>`),200==a.status){const e=$(".action-btns .like i");e.attr("class").includes("far")?e.removeClass("far").addClass("fas text-primary"):e.removeClass("fas text-primary").addClass("far")}}function targetCommentsClick(e){const t=$(e.target);"view-btn"==t.attr("id")?viewNReplies(t):"reply"==t.attr("id")?checkLogged((function(){targetRenderReply(...arguments)}),t):"reply-ok"==t.attr("id")?checkLogged((function(){targetPostReply(...arguments)}),t):"view-reps"==t.attr("id")?insertMoreReps(t.parent().parent()):"like-rep"==t.attr("id")?checkLogged((function(){likeComment(...arguments)}),t,"like"):"dislike-rep"==t.attr("id")&&checkLogged((function(){likeComment(...arguments)}),t,"dislike")}async function initComments(){if(g$cmt_page_number){g$cmt_req_pending=!0;const e=$("div#comment-scroll");e.css("display","flex");const t=await fetchComments();null!==t&&(addCommentsToDom(t.cmts),t.hnext?g$cmt_page_number++:g$cmt_page_number=null,g$cmt_req_pending=!1),e.css("display","none")}}async function fetchComments(){const e={page:g$cmt_page_number,pid:g$post_id},t=await postRequest("/post/comment/get/",e);return 200==t.status?t:null}function addCommentsToDom(e){const t=getCommentBoil("reps_btn"),n=getCommentBoil("reply"),i=document.createDocumentFragment();e.forEach(e=>{let a=replaceBoil(e,"parent");const o=e.reps_len;o>0&&(a=a.slice(0,-6)+t.replace("$rep_length$",o)+n.replace("$reps$","")+"</div>");let c=document.createElement("span");c.innerHTML=a,o>0&&$(c).children().first().attr("data-page",1),i.appendChild(c)}),g$cmt_section.append(i)}function replaceBoil(e,t){let n=getCommentBoil("comment");const i=[/\$uname\$/g,/\$img\$/,/\$comment\$/,/\$time\$/,/\$cid\$/g,/\$level\$/,/\$dl\$/,/\$ddl\$/,/\$nlike\$/],a=e.hasOwnProperty("like")?e.like:1;return[e.name,e.img,e.cmt.replace(/\n/g,"<br>"),e.time+" ago",e.id,t,"11"==a?0:1,"01"==a?0:1,Number(e.nlike)>0?e.nlike:""].forEach((e,t)=>{n=n.replace(i[t],e)}),n}function showHideReplies(e,t){let n={dot_replies:"block",opposite_val:["View","Hide"],data_val:"hide",sort_icon:["down","up"]};"hide"==t&&(n={dot_replies:"none",opposite_val:["Hide","View"],data_val:"show",sort_icon:["up","down"]});const i=e.find("img#sort-con").attr("src");e.html(e.html().replace(n.opposite_val[0],n.opposite_val[1]).replace(i,i.replace(n.sort_icon[0],n.sort_icon[1]))).attr("data-display",n.data_val),e.parent().find(".replies").css("display",n.dot_replies)}async function insertMoreReps(e){const t=e.attr("id").split("-")[1],n=e.attr("data-page"),i=e.find("div.replies");i.find("button#view-reps").remove(),i.append(g$spin_code);const a=await fetchNReplies(t,n);if(i.find("div.spinner-border").remove(),a){addCommentReplies(a.reps,t,!0);let o=Number(n)+1;a.hnext?i.append(getCommentBoil("more-reps")):o="null",e.attr("data-page",o)}}async function viewNReplies(e){"show"==e.attr("data-display")?(e.parent().find(".replies").children().length||insertMoreReps(e.parent()),showHideReplies(e,"show")):showHideReplies(e,"hide")}async function fetchNReplies(e,t){const n={cid:e,pnum:t},i=await postRequest("/post/comment/reply/get/",n);return 200==i.status?i:null}function addCommentReplies(e,t,n){let i="";if(comment=$("#comment-"+t),e.forEach(e=>{"object"==typeof e.cmt&&(e={...e,cmt:`<a class="reply-link" href="/users/profile/${e.cmt[0]}">@${e.cmt[0]}</a> ${e.cmt[1]}`}),i+=replaceBoil(e,"child")}),n)comment.find(".replies").append(i);else{const e=getCommentBoil("reps_btn").replace("$rep_length$",0)+getCommentBoil("reply");comment.append(e.replace("$reps$",i))}}async function likeComment(e,t){const n=e.parent().parent().parent().attr("data-reply"),i=e.attr.bind(e),a=i("data-"+t),o={cid:n,action:a,type:"like"==t?1:0};e.children().css("display","none"),e.append(g$spin_code);const c=await postRequest("/post/comment/like/",o);if(e.children().last().remove(),e.children().css("display","inline-block"),200==c.status){if(i("data-"+t,"1"==a?"0":"1"),"like"==t){const t=e.children().last();let n=t.text().trim();"1"==a?n=0==n.length?1:Number(n)+1:(n=Number(n)-1,0==n&&(n="")),t.text(n)}const[n,o]="like"==t?["dislike",e.next.bind(e)]:["like",e.prev.bind(e)];"0"==o().attr("data-"+n)&&("like"==n&&(count_tag=o().children().last(),count_val=count_tag.text().trim(),count_val=Number(count_val)-1,0==count_val&&(count_val=""),count_tag.text(count_val)),o().attr("data-"+n,"1"))}}function checkLogged(){if(g$logged){const[e,...t]=arguments;e(...t)}else{const{origin:e,pathname:t}=window.location;window.location.replace(e+"/users/login/?next="+t)}}function getCommentBoil(e){return"comment"==e?'<div class="comment area-wrap" id="comment-$cid$" data-reply="$cid$" data-level="$level$"><img src="$img$" alt="$uname$" class="t-comment-img"><div class="comment-text-side"><p class="commenter"><a class="user-link" id="user-link" href="/users/profile/$uname$">$uname$</a><span class="comment-time text-muted">$time$</span></p><p class="comment-text">$comment$</p><div class="comment-actions flex"><button class="comment-action cmt-con" id="like-rep" data-like="$dl$"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="16px" height="16px"><path d="M0 0h24v24H0V0z" fill="none" /><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z" /></svg><span class="action-value text-muted">$nlike$</span></button><button class="cmt-con" id="dislike-rep" data-dislike="$ddl$"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="16px" height="16px"><path d="M0 0h24v24H0z" fill="none"/><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg></button><button class="cmt-con" id="reply"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="16px" height="16px"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/><path d="M0 0h24v24H0z" fill="none"/></svg></button></div></div></div>':"reply"==e?'<div class="replies">$reps$</div>':"reps_btn"==e?'<button class="btn btn-link flex view-more" id="view-btn" data-display="show"><img id="sort-con" src="/static/shamsla/images/down.svg" alt="view replies">View $rep_length$ replies</button>':"reply_input"==e?`<div class="area-wrap active-reply" id="active-reply"> <img src="${g$user_avatar}" alt="${g$user_name}" class="user-img reply-img"> <textarea name="comment" id="comment-area" rows="1" class="comment-area reply-comment form-control" placeholder="Write Your Reply"></textarea> <div class="area-actions"> <button id="reply-ok" class="btn-sm btn btn-primary" disabled>Reply</button> <button id="comment-cancel" class="btn-sm btn btn-light">Cancel</button> </div></div>`:"more-reps"==e?'<button class="btn btn-link flex" id="view-reps"><img src="/static/shamsla/images/more.svg" alt="view more"> View More</button>':void 0}$(".action-btns .like").on("click",targetAction),$("button.following").on("click",targetFollowing),function(){const e=$(".action-btns"),t=e.offset().top-95,n=()=>e.removeClass("stick-action");$window.on("scroll",i=>{$window.width()>767&&$window.scrollTop()>t?(n(),e.addClass("stick-action")):n()})}(),$(document).on("keyup","textarea#comment-area",e=>checkLogged((function(){targetDisplayBtns(...arguments)}),e)),$("#comment-wrap").on("click","div.area-wrap button#comment-cancel",e=>checkLogged((function(){targetCancel(...arguments)}),e)),g$cmt_section.on("click",e=>targetCommentsClick(e)),g$cmt_area.on("click",e=>checkLogged((function(){targetMainComment(...arguments)}),e)),$window.on("scroll",e=>{$window.scrollTop()+$window.height()>$(document).height()-200&&g$cmt_page_number&&!g$cmt_req_pending&&initComments()});